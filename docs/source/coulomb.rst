

クーロンカウンタ（ベータ版）
----------------------------------

クーロンカウンタのアルゴリズムはバッテリー容量の計算の精度を向上させることができますが、現在はベータ段階にあり、大きな誤差が生じる可能性があります。十分な注意を払って使用してください。

**クーロンカウンタを有効にする**

1. Home Assistantのページに移動し、左のサイドバーで「Developer Tools」をクリックします。
2. Developer Toolsのページで、「Services」タブを選択します。
3. サービスのリストから、 ``ESPHome: pipower_pro_enable_coulomb_count_beta`` を選択します。
4. ``enable_coulomb_count_beta`` のスイッチをオンにします。
5. 下の「**Call Service**」ボタンをクリックします。
6. エンティティ ``sensor.pipower_pro_battery_capacity_algorithm`` で現在選択されているバッテリー容量のアルゴリズムを確認できます。

**アルゴリズム**

クーロンカウンタのアルゴリズムは、毎秒バッテリーの電流と電圧の測定を積分してエネルギーを計算します。

``Capacity += Voltage * Current``

**マッチング**

この積分によって計算される容量は、現在の時点からの充放電エネルギーのみです。実際のバッテリー容量と関連付けるためのマッチングプロセスが必要です。ここでのマッチング方法はシンプルです。PiPower Proのデフォルトのバッテリー容量はバッテリーの名目容量、すなわち2000mAhです。実際のバッテリー容量はこの値よりも小さいでしょう。バッテリーが充電される限り、容量は最大2000mAh（ ``set_battery_factory_capacity`` のサービスを使用して変更可能）に設定されるため、バッテリーが完全に充電されたとき、容量値は実際のバッテリー容量の2000mAhと一致し、積分計算値も実際のバッテリー容量値と一致します。

**自動キャリブレーション**

積分は誤差を蓄積する可能性があり、バッテリーが時間とともに使用されるとバッテリー容量は減少し、名目2000mAh容量に達しないかもしれません。したがって、バッテリー容量をキャリブレートするためのいくつかのキャリブレーション方法を使用する必要があります。

ここでは、補償放電終了電圧（CEDV）キャリブレーション方法を使用します。CEDVキャリブレーション方法の原理は、放電終了時の電圧が比較的正確であり、この時の電圧曲線も最も急であることです。この電圧をキャリブレーションポイントとして使用するのは適切です。したがって、3つのEDVポイントを設定します：edv2（7％）、edv1（3％）、およびedv0（0％）。

これら3つのキャリブレーション電圧を設定した後、バッテリーがこれら3つのポイントに放電されたとき、PiPower Proはバッテリーをキャリブレートします： ``MaxCapacity = MaxCapacity - Capacity + MaxCapacity * 7%`` 。電圧の変動により同じポイントでの無制限のキャリブレーションを避けるため、充電がRCV（Reset Calibration Voltage、デフォルト8.0V）に達する前にキャリブレーションは一度に制限されます。edv2、edv1、edv0、およびrcvはServiceサービスで設定できます。詳細は :ref:`entity` を参照してください。

**インジケータ**

クーロンカウンタアルゴリズムが有効になると、バッテリーインジケータもクーロンカウンタモードに切り替わります。ただし、バッテリーレベルの読み取りが正しくない、またはバッテリーレベルがリセットされる可能性がわずかにあります。

バッテリーインジケータと電力との関係は次のとおりです：

* 4つのLEDすべてが点灯：75％
* 3つのLEDが点灯：50％
* 2つのLEDが点灯：25％
* 1つのLEDが点灯：10％
* 4つのLEDすべてが消灯：0％、バッテリーの充電が必要です。

